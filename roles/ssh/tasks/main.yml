---
- name: Find SSH Keys
  find:
    paths: "/etc/ssh/"
    patterns: "*_key"
  register: find_ssh
  tags:
  - AC
  - AC-6

- name: Verify Permissions on SSH Server Private *_key Key Files
  file:
    dest: "{{ item.path }}"
    mode: 0600
  with_items: "{{ find_ssh.files }}"
  tags:
  - AC
  - AC-6

- name: Allow Only SSH Protocol 2
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*Protocol [0-9]"
    line: "Protocol 2"
  notify: restart sshd
  tags:
    - conf-low
    - conf-medium
    - conf-high
    - int-low
    - int-medium
    - int-high
    - IA
    - IA-5
    - IA-5(1)
    - IA-5(c)

- name: Set SSH Idle Timeout Interval
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*ClientAliveInterval.*"
    line: "ClientAliveInterval 600"
  notify: restart sshd
  tags:
    - CAT-II
    - AC
    - AC-2
    - AC-2(5)

- name: Set SSH Client Alive Count
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*ClientAliveCountMax.*"
    line: "ClientAliveCountMax 3"
  notify: restart sshd
  tags:
    - CAT-II
    - AC
    - AC-2
    - AC-2(5)

- name: Disable SSH Support for .rhosts Files
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*IgnoreRhosts.*"
    line: "IgnoreRhosts yes"
  notify: restart sshd
  tags:
    - CAT-II
    - AC
    - AC-3

- name: Disable Host-Based Authentication
  lineinfile:
    dest: /etc/ssh/sshd_config
    line: "HostbasedAuthentication no"
    state: present
  notify: restart sshd
  tags:
    - CAT-II
    - AC-3
    - AC

- name: Disable SSH Root Login
  lineinfile:
    dest: /etc/ssh/sshd_config
    line: "PermitRootLogin no"
    state: present
  notify: restart sshd
  tags:
    - CAT-II
    - AC
    - AC-3
    - AC-6
    - AC-6(2)
    - IA
    - IA-2
    - IA-2(1)

- name: Disable SSH Access via Empty Passwords
  lineinfile:
    dest: /etc/ssh/sshd_config
    line: "PermitEmptyPasswords no"
    state: present
  notify: restart sshd
  tags:
    - CAT-II
    - AC
    - AC-3

- name: Use Only Approved Ciphers
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*Ciphers.*"
    line: "Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc,aes192-cbc,aes256-cbc"
  notify: restart sshd
  tags:
    - AC
    - AC-3
    - AC-17
    - AC-17(2)

- name: Use Only FIPS Approved MACs
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*MACs.*"
    line: MACs hmac-sha2-512,hmac-sha2-256,hmac-sha1
  notify: restart sshd
  tags:
  - AC
  - AC-17
  - AC-17(2)
  - IA
  - IA-7
  - SC
  - SC-13

- name: Disable SSH Support for Rhosts RSA Authentication
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*RhostsRSAAuthentication.*"
    line: "RhostsRSAAuthentication no"
  notify: restart sshd
  tags:
    - CM
    - CM-6
    - CM-6(a)

- name: Enable Use of StrictModes
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*StrictModes.*"
    line: StrictModes yes
  notify: restart sshd
  tags:
  - AC
  - AC-6

- name: Enable Use of Privilege Separation
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*UsePrivilegeSeparation.*"
    line: UsePrivilegeSeparation yes
  notify: restart sshd
  tags:
  - AC
  - AC-6

- name: Disable SSH Support for User Known Hosts
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*IgnoreUserKnownHosts.*"
    line: "IgnoreUserKnownHosts yes"
  notify: restart sshd
  tags:
    - CM
    - CM-6
    - CM-6(a)

- name: Disable Compression Or Set Compression to delayed
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*Compression.*"
    line: Compression delayed
  notify: restart sshd
  tags:
  - CM
  - CM-6
  - CM-6(b)

- name: Do Not Allow SSH Environment Options
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: ".*PermitUserEnvironment.*"
    line: "PermitUserEnvironment no"
    state: present
  notify: restart sshd
  tags:
    - CAT-II
